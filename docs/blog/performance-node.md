# 性能优化Nodejs调优

- 内存泄漏
- 压力测试
- 编码规范

## 内存泄漏的概念和所造成的影响

### 概念

程序的运行需要内存，只要程序员提出要求，操作系统或者运行时（runtime）就必须供给内存。  

对于持续运行的服务进程（deamon），必须及时释放不再用到的内存。否则，内存占用越来越高，轻则影响系统性能，重则导致进程崩溃。不再用到的内存，没有及时释放，就叫做内存泄漏（memoryleak）。

有些语言（比如C语言）必须手动释放内存，程序员负责内存管理。

### 具体表现

- 随着内存泄漏的增长，V8对垃圾收集器越来越具有攻击性，这会使你的应用运行速度变慢。
- 内存泄漏可能触发其他类型的失败，内存泄漏的代码可能会持续引用有限的资源。你可能会耗尽文件描述符；你还可能会突然不能建立新的数据连接。
- 你的应用迟早会崩溃，并且在你的应用收到欢迎时肯定会发生。
- 浏览器端也会发生内存泄漏，只不过浏览器只针对一端，会造成网页卡顿。

## 压力测试寻找内存泄漏

### 压力测试工具

#### WRK 
- -t 需要模拟的线程数
- -c 需要模拟的连接数
- --timeout 超时的时间
- -d 测试的持续时间
- ./wrk -t12 -c400 -d30s http://127.0.0.1:3000  
  用12个线程模拟400个链接 在30秒内。一般线程数不宜过多，核数的2到4倍足够。

 | 项目    | 名称  | 说明           |
 | ------ | ----- | ------------  |
 | Avg    | 平均值 | 每次测试的平均值 |
 | Stdev  | 标准偏差 | 结果离散程度，越高说明越不稳定 |
 | Max    | 最大值 | 最大的一次结果 | 
 | +/- Stdev| 正负一个标准差占比 | 结果离散程度，越大越不稳定|

 Latency： 可以理解为响应时间
 Req/Sec：每个线程每秒钟的完成的请求数.  

::: tip 
  一般我们来说我们主要关注平均值和最大值.  
  标准差如果太大说明样本本身离散程度比较高. 有可能系统性能波动很大
:::


